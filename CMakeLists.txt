cmake_minimum_required(VERSION 3.9)

project(city4cfd)

#set( CMAKE_ALLOW_LOOSE_LOOP_CONSTRUCTS true )

set(CMAKE_CXX_FLAGS "-O2")
set(CMAKE_BUILD_TYPE "Release")

if (COMMAND cmake_policy)
    cmake_policy(SET CMP0003 NEW)
endif()

if (MSVC)
    add_definitions(-DNOMINMAX)
    add_definitions("/EHsc")
endif (MSVC)

# BOOST
find_package(Boost 1.66 REQUIRED COMPONENTS filesystem locale)
if (WIN32)
    FIND_PACKAGE(Boost)
    if (Boost_FOUND)
        INCLUDE_DIRECTORIES(${Boost_INCLUDE_DIR})
        ADD_DEFINITIONS( "-DHAS_BOOST" )
        set(Boost_USE_STATIC_LIBS   ON)
        set(Boost_ARCHITECTURE "-x64")
    endif()
endif (WIN32)

# CGAL
find_package(CGAL REQUIRED QUIET COMPONENTS)
if (CGAL_VERSION VERSION_GREATER_EQUAL "5.0")
    message(STATUS "Found CGAL version greater than 5.0")
    include_directories(${CMAKE_SOURCE_DIR}/thirdparty/CGAL/include)
    set(CGAL_USE_INCLUDED_HEADERS ON)
else()
    message(FATAL_ERROR "Found CGAL version ${CGAL_VERSION} which is not supported!"
            "Please use CGAL version 5")
    return()
endif ()

# GDAL
find_package(GDAL REQUIRED 3.0)
if (NOT GDAL_FOUND)
    message(SEND_ERROR "City4CFD requires the GDAL library, check the README for configuration")
endif()
include_directories(${GDAL_INCLUDE_DIR})

# Eigen
find_package(Eigen3 3.2.0) #(requires 3.2.0 or greater)
include(${CMAKE_SOURCE_DIR}/thirdparty/CGAL/cmake/CGAL_Eigen3_support.cmake)

# OpenMP
find_package(OpenMP)
if (OpenMP_CXX_FOUND)
    set(OpenMP_support "OpenMP::OpenMP_CXX")
else()
    message(STATUS "OpenMP not found. All functions will run single-threaded")
endif()

# Third-party
add_subdirectory(${CMAKE_SOURCE_DIR}/thirdparty/LAStools)
add_subdirectory(${CMAKE_SOURCE_DIR}/thirdparty/CSF/src)
include_directories(${CMAKE_SOURCE_DIR}/thirdparty)
include_directories(${CMAKE_SOURCE_DIR}/thirdparty/valijson)
include_directories(${Boost_INCLUDE_DIR})

# Tools
add_subdirectory(${CMAKE_SOURCE_DIR}/tools/prepare_point_cloud)

# Creating entries for target: City4CFD
FILE(GLOB SRC_FILES "src/*.cpp")
add_executable(city4cfd ${SRC_FILES})
set_target_properties(
        city4cfd
        PROPERTIES CXX_STANDARD 14
)

target_link_libraries(city4cfd
        ${CGAL_LIBRARIES}
        ${CGAL_3RD_PARTY_LIBRARIES}
        ${GDAL_LIBRARY}
        ${Boost_SYSTEM_LIBRARY}
        ${Boost_FILESYSTEM_LIBRARY}
        ${Boost_LOCALE_LIBRARY}
        LASlib
        CGAL::Eigen3_support
        ${OpenMP_support}
        )

install(TARGETS city4cfd DESTINATION bin)
